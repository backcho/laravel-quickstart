# 04. 예제: 백오피스 (RBAC + 회원관리 + 통계)

> 목표: AI에게 요청할 백오피스 기능 명세

이 문서는 관리자 전용 백오피스 구현을 위한 **명세서**입니다.

---

## 1. spatie/laravel-permission 설정

### 패키지 설치

```bash
# 패키지 설치
composer require spatie/laravel-permission

# 설정 파일 및 마이그레이션 퍼블리시
php artisan vendor:publish --provider="Spatie\Permission\PermissionServiceProvider"

# 마이그레이션 실행
php artisan migrate
```

### User 모델 설정

```php
// app/Models/User.php
use Spatie\Permission\Traits\HasRoles;

class User extends Authenticatable
{
    use HasRoles;
    // ... 기존 코드
}
```

### 기본 역할 생성

```bash
php artisan make:seeder RoleSeeder
```

```php
// database/seeders/RoleSeeder.php
use Spatie\Permission\Models\Role;

class RoleSeeder extends Seeder
{
    public function run(): void
    {
        Role::create(['name' => 'admin']);
        Role::create(['name' => 'user']);
    }
}

// database/seeders/DatabaseSeeder.php
public function run(): void
{
    $this->call(RoleSeeder::class);
}
```

```bash
php artisan db:seed --class=RoleSeeder
```

### 회원가입 시 기본 역할 부여

```php
// app/Http/Controllers/Auth/RegisterController.php
// 또는 회원가입 로직이 있는 곳에서

protected function create(array $data)
{
    $user = User::create([
        'name' => $data['name'],
        'email' => $data['email'],
        'password' => Hash::make($data['password']),
    ]);

    $user->assignRole('user');  // 기본 역할 부여

    return $user;
}
```

---

## 2. 라우트 분리

### 백오피스 라우트 그룹

```php
// routes/web.php
use App\Http\Controllers\Admin\DashboardController;
use App\Http\Controllers\Admin\UserController as AdminUserController;

// 관리자 전용 라우트
Route::prefix('admin')
    ->middleware(['auth', 'role:admin'])
    ->name('admin.')
    ->group(function () {
        
        // 대시보드
        Route::get('/', [DashboardController::class, 'index'])->name('dashboard');
        
        // 회원 관리
        Route::resource('users', AdminUserController::class)->only([
            'index', 'show', 'edit', 'update', 'destroy'
        ]);
        
        // 회원 역할 변경
        Route::patch('users/{user}/role', [AdminUserController::class, 'updateRole'])
            ->name('users.role');
});
```

### URL 구조

| 경로 | 이름 | 설명 |
|------|------|------|
| GET /admin | admin.dashboard | 대시보드 |
| GET /admin/users | admin.users.index | 회원 목록 |
| GET /admin/users/{user} | admin.users.show | 회원 상세 |
| GET /admin/users/{user}/edit | admin.users.edit | 회원 수정 폼 |
| PUT /admin/users/{user} | admin.users.update | 회원 수정 |
| DELETE /admin/users/{user} | admin.users.destroy | 회원 삭제 |
| PATCH /admin/users/{user}/role | admin.users.role | 역할 변경 |

---

## 3. 대시보드 (통계)

### 표시할 통계

#### 회원 통계
- 전체 회원 수
- 오늘 가입자 수
- 이번 주 가입자 수
- 이번 달 가입자 수

#### 게시글 통계
- 전체 게시글 수
- 오늘 작성된 게시글 수
- 최근 7일 게시글 추이 (일별)

### 컨트롤러

```php
// app/Http/Controllers/Admin/DashboardController.php
namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Models\User;
use App\Models\Post;
use Carbon\Carbon;

class DashboardController extends Controller
{
    public function index()
    {
        // 회원 통계
        $userStats = [
            'total' => User::count(),
            'today' => User::whereDate('created_at', today())->count(),
            'thisWeek' => User::whereBetween('created_at', [
                now()->startOfWeek(),
                now()->endOfWeek()
            ])->count(),
            'thisMonth' => User::whereMonth('created_at', now()->month)
                ->whereYear('created_at', now()->year)
                ->count(),
        ];

        // 게시글 통계
        $postStats = [
            'total' => Post::count(),
            'today' => Post::whereDate('created_at', today())->count(),
        ];

        // 최근 7일 게시글 추이
        $postTrend = collect(range(6, 0))->map(function ($daysAgo) {
            $date = now()->subDays($daysAgo);
            return [
                'date' => $date->format('m/d'),
                'count' => Post::whereDate('created_at', $date)->count(),
            ];
        });

        // 최근 가입 회원
        $recentUsers = User::latest()->take(5)->get();

        // 최근 게시글
        $recentPosts = Post::with('user')->latest()->take(5)->get();

        return view('admin.dashboard', compact(
            'userStats',
            'postStats',
            'postTrend',
            'recentUsers',
            'recentPosts'
        ));
    }
}
```

### 대시보드 뷰

```blade
{{-- resources/views/admin/dashboard.blade.php --}}
@extends('layouts.app')

@section('content')
<div class="container">
    <h1>관리자 대시보드</h1>

    {{-- 통계 카드 --}}
    <div class="row">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5>전체 회원</h5>
                    <h2>{{ number_format($userStats['total']) }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5>오늘 가입</h5>
                    <h2>{{ number_format($userStats['today']) }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5>전체 게시글</h5>
                    <h2>{{ number_format($postStats['total']) }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5>오늘 게시글</h5>
                    <h2>{{ number_format($postStats['today']) }}</h2>
                </div>
            </div>
        </div>
    </div>

    {{-- 차트 (선택적) --}}
    {{-- Chart.js 등으로 postTrend 데이터 시각화 --}}

    {{-- 최근 활동 --}}
    <div class="row mt-4">
        <div class="col-md-6">
            <h4>최근 가입 회원</h4>
            {{-- recentUsers 목록 --}}
        </div>
        <div class="col-md-6">
            <h4>최근 게시글</h4>
            {{-- recentPosts 목록 --}}
        </div>
    </div>
</div>
@endsection
```

---

## 4. 회원 관리

### 구현할 기능

#### 회원 목록
- **경로**: `GET /admin/users`
- **기능**:
  - 페이지네이션 (20개씩)
  - 검색 (이름, 이메일)
  - 역할별 필터링
  - 가입일순/이름순 정렬

#### 회원 상세
- **경로**: `GET /admin/users/{user}`
- **표시 정보**:
  - 기본 정보 (이름, 이메일, 가입일)
  - 현재 역할
  - 작성한 게시글 수
  - 최근 활동

#### 역할 변경
- **경로**: `PATCH /admin/users/{user}/role`
- **기능**:
  - user ↔ admin 역할 전환
  - 자기 자신은 변경 불가

#### 회원 삭제 (soft delete)
- **경로**: `DELETE /admin/users/{user}`
- **기능**:
  - 실제 삭제가 아닌 soft delete
  - 자기 자신은 삭제 불가

### User 모델에 SoftDeletes 추가

```php
// app/Models/User.php
use Illuminate\Database\Eloquent\SoftDeletes;

class User extends Authenticatable
{
    use HasRoles, SoftDeletes;
    // ...
}
```

```bash
# soft delete 마이그레이션
php artisan make:migration add_soft_deletes_to_users_table
```

```php
// 마이그레이션
Schema::table('users', function (Blueprint $table) {
    $table->softDeletes();
});
```

### 컨트롤러

```php
// app/Http/Controllers/Admin/UserController.php
namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Models\User;
use Illuminate\Http\Request;

class UserController extends Controller
{
    public function index(Request $request)
    {
        $query = User::query();

        // 검색
        if ($search = $request->input('search')) {
            $query->where(function ($q) use ($search) {
                $q->where('name', 'like', "%{$search}%")
                  ->orWhere('email', 'like', "%{$search}%");
            });
        }

        // 역할 필터
        if ($role = $request->input('role')) {
            $query->role($role);
        }

        // 정렬
        $sortBy = $request->input('sort', 'created_at');
        $sortOrder = $request->input('order', 'desc');
        $query->orderBy($sortBy, $sortOrder);

        $users = $query->paginate(20)->withQueryString();

        return view('admin.users.index', compact('users'));
    }

    public function show(User $user)
    {
        $user->load('posts');
        $postCount = $user->posts()->count();

        return view('admin.users.show', compact('user', 'postCount'));
    }

    public function updateRole(Request $request, User $user)
    {
        // 자기 자신은 변경 불가
        if ($user->id === auth()->id()) {
            return back()->with('error', '자신의 역할은 변경할 수 없습니다.');
        }

        $newRole = $request->input('role');

        // 기존 역할 제거 후 새 역할 부여
        $user->syncRoles([$newRole]);

        return back()->with('success', '역할이 변경되었습니다.');
    }

    public function destroy(User $user)
    {
        // 자기 자신은 삭제 불가
        if ($user->id === auth()->id()) {
            return back()->with('error', '자신의 계정은 삭제할 수 없습니다.');
        }

        $user->delete(); // soft delete

        return redirect()->route('admin.users.index')
            ->with('success', '회원이 삭제되었습니다.');
    }
}
```

---

## 5. 디렉토리 구조

```
app/Http/Controllers/Admin/
├── DashboardController.php
└── UserController.php

resources/views/admin/
├── dashboard.blade.php
└── users/
    ├── index.blade.php
    ├── show.blade.php
    └── edit.blade.php
```

---

## 6. 네비게이션에 관리자 메뉴 추가

```blade
{{-- resources/views/layouts/app.blade.php 네비게이션 부분 --}}

@auth
    @if(auth()->user()->hasRole('admin'))
        <li class="nav-item">
            <a class="nav-link" href="{{ route('admin.dashboard') }}">
                관리자
            </a>
        </li>
    @endif
@endauth
```

---

## 7. 첫 관리자 계정 생성

```bash
php artisan tinker
```

```php
// Tinker에서 실행
$user = \App\Models\User::where('email', 'admin@example.com')->first();
// 또는 새로 생성
$user = \App\Models\User::create([
    'name' => 'Admin',
    'email' => 'admin@example.com',
    'password' => bcrypt('password'),
]);
$user->assignRole('admin');
```

---

## 8. AI에게 요청하는 프롬프트 예시

```
Laravel 11 프로젝트에 관리자 백오피스를 추가해주세요.

요구사항:
1. spatie/laravel-permission으로 RBAC 구현
   - 역할: admin, user
   - 회원가입 시 기본 user 역할 부여

2. /admin 라우트 그룹 (admin 역할만 접근)

3. 대시보드 (/admin)
   - 회원 통계: 전체, 오늘, 이번 주, 이번 달
   - 게시글 통계: 전체, 오늘
   - 최근 7일 게시글 추이
   - 최근 가입 회원 5명
   - 최근 게시글 5개

4. 회원 관리 (/admin/users)
   - 목록: 페이지네이션, 검색, 역할 필터
   - 상세: 회원 정보 + 게시글 수
   - 역할 변경: user ↔ admin (본인 제외)
   - 삭제: soft delete (본인 제외)

5. 네비게이션에 관리자 메뉴 추가 (admin만 보임)
```

---

## 다음 단계

백오피스가 완성되었습니다! [05_서비스공개.md](./05_서비스공개.md)에서 외부에 공개하는 방법을 알아봅니다.
